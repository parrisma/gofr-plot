#!/bin/bash
#
# gplot.env - Single Source of Truth for gplot Environment Configuration
#
# This file defines all environment variables and paths for the gplot project.
# It supports two operational modes:
#   - TEST: Uses test/data/ for all storage (default for testing)
#   - PROD: Uses data/ for all storage (production deployments)
#
# Usage:
#   source gplot.env
#   export GPLOT_ENV=PROD && source gplot.env
#

# ============================================================================
# Environment Mode
# ============================================================================
export GPLOT_ENV="${GPLOT_ENV:-TEST}"

# Set base data path based on environment
if [ "${GPLOT_ENV}" = "PROD" ]; then
    GPLOT_ENV_PATH="data"
else
    GPLOT_ENV_PATH="test/data"
fi

# ============================================================================
# Project Root and Core Paths
# ============================================================================
export GPLOT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export GPLOT_DATA="${GPLOT_ROOT}/${GPLOT_ENV_PATH}"
export GPLOT_LOGS="${GPLOT_ROOT}/logs"

# ============================================================================
# Service-Specific Data Paths
# ============================================================================
export GPLOT_AUTH="${GPLOT_DATA}/auth"
export GPLOT_STORAGE="${GPLOT_DATA}/storage"
export GPLOT_METADATA="${GPLOT_DATA}/metadata"

# ============================================================================
# Token Store Path
# ============================================================================
# NOTE: Token store is environment-specific to prevent test/prod token collision
if [ "${GPLOT_ENV}" = "PROD" ]; then
    export GPLOT_TOKEN_STORE="${GPLOT_LOGS}/gplot_tokens.json"
else
    export GPLOT_TOKEN_STORE="${GPLOT_LOGS}/gplot_tokens_test.json"
fi

# ============================================================================
# Server Ports (Centralized Configuration)
# ============================================================================
export GPLOT_MCP_PORT="${GPLOT_MCP_PORT:-8010}"
export GPLOT_MCPO_PORT="${GPLOT_MCPO_PORT:-8011}"
export GPLOT_WEB_PORT="${GPLOT_WEB_PORT:-8012}"

# ============================================================================
# Web Server URL Configuration
# ============================================================================
# Default to hostname-based URL for external accessibility
export GPLOT_HOSTNAME="${GPLOT_HOSTNAME:-$(hostname)}"
export GPLOT_WEB_URL="${GPLOT_WEB_URL:-http://${GPLOT_HOSTNAME}:${GPLOT_WEB_PORT}}"

# ============================================================================
# Auto-Create Required Directories
# ============================================================================
mkdir -p "${GPLOT_AUTH}" "${GPLOT_STORAGE}" "${GPLOT_METADATA}" "${GPLOT_LOGS}"

# ============================================================================
# Environment Validation and Display
# ============================================================================
if [ "${GPLOT_SHOW_ENV:-0}" = "1" ]; then
    echo "=== gplot Environment Configuration ==="
    echo "GPLOT_ENV:          ${GPLOT_ENV}"
    echo "GPLOT_ROOT:         ${GPLOT_ROOT}"
    echo "GPLOT_DATA:         ${GPLOT_DATA}"
    echo "GPLOT_LOGS:         ${GPLOT_LOGS}"
    echo "GPLOT_AUTH:         ${GPLOT_AUTH}"
    echo "GPLOT_STORAGE:      ${GPLOT_STORAGE}"
    echo "GPLOT_METADATA:     ${GPLOT_METADATA}"
    echo "GPLOT_TOKEN_STORE:  ${GPLOT_TOKEN_STORE}"
    echo "GPLOT_MCP_PORT:     ${GPLOT_MCP_PORT}"
    echo "GPLOT_MCPO_PORT:    ${GPLOT_MCPO_PORT}"
    echo "GPLOT_WEB_PORT:     ${GPLOT_WEB_PORT}"
    echo "GPLOT_WEB_URL:      ${GPLOT_WEB_URL}"
    echo "========================================"
fi
