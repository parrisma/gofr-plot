services:
  # 1. MCP Server (Core Logic)
  mcp:
    image: gofr-plot_prod:latest
    container_name: gofr-plot-mcp
    restart: unless-stopped
    command: python -m app.main_mcp --no-auth --host 0.0.0.0 --port 8010
    environment:
      - GOFR_PLOT_ENV=PROD
      - GOFR_PLOT_LOG_LEVEL=INFO
      # Web URL for proxy mode - use container hostname
      - GOFR_PLOT_WEB_URL=http://gofr-plot-web:8012
      # For production with auth, uncomment and set:
      # - GOFR_PLOT_JWT_SECRET=your-secret-key-here
    ports:
      - "8010:8010"
    volumes:
      - gofr_data:/home/gofr-plot/data
    networks:
      - gofr-net

  # 2. MCPO Server (OpenAPI Wrapper)
  mcpo:
    image: gofr-plot_prod:latest
    container_name: gofr-plot-mcpo
    restart: unless-stopped
    depends_on:
      - mcp
    command: python -m app.main_mcpo
    environment:
      - GOFR_PLOT_ENV=PROD
      # MCPO needs to connect to MCP server using container hostname
      - GOFR_PLOT_MCP_PORT=8010
      - GOFR_PLOT_MCP_HOST=gofr-plot-mcp
      - GOFR_PLOT_MCPO_PORT=8011
      - GOFR_PLOT_HOST=0.0.0.0
    ports:
      - "8011:8011"
    volumes:
      - gofr_data:/home/gofr-plot/data
    networks:
      - gofr-net

  # 3. Web Server (Frontend/API)
  web:
    image: gofr-plot_prod:latest
    container_name: gofr-plot-web
    restart: unless-stopped
    command: python -m app.main_web --no-auth --host 0.0.0.0 --port 8012
    environment:
      - GOFR_PLOT_ENV=PROD
      # For production with auth, uncomment and set:
      # - GOFR_PLOT_JWT_SECRET=your-secret-key-here
    ports:
      - "8012:8012"
    volumes:
      - gofr_data:/home/gofr-plot/data
    networks:
      - gofr-net

  # 4. Backup Service (Sidecar using gofr-common shared backup)
  backup:
    image: gofr-common-backup:latest
    container_name: gofr-plot-backup
    restart: unless-stopped
    depends_on:
      - mcp
      - web
    environment:
      # Project identifier (required)
      - GOFR_PROJECT=plot
      
      # Backup scheduling
      - GOFR_PLOT_BACKUP_ENABLED=${GOFR_PLOT_BACKUP_ENABLED:-true}
      - GOFR_PLOT_BACKUP_SCHEDULE=${GOFR_PLOT_BACKUP_SCHEDULE:-0 2 * * *}
      
      # Retention policies
      - GOFR_PLOT_BACKUP_RETENTION_DAYS=${GOFR_PLOT_BACKUP_RETENTION_DAYS:-30}
      - GOFR_PLOT_BACKUP_MAX_COUNT=${GOFR_PLOT_BACKUP_MAX_COUNT:-90}
      
      # What to backup (paths relative to /data)
      - GOFR_PLOT_BACKUP_PATHS=${GOFR_PLOT_BACKUP_PATHS:-storage:storage,auth:auth,logs:../logs}
      
      # Compression
      - GOFR_PLOT_BACKUP_COMPRESSION=${GOFR_PLOT_BACKUP_COMPRESSION:-gzip}
      - GOFR_PLOT_BACKUP_COMPRESSION_LEVEL=${GOFR_PLOT_BACKUP_COMPRESSION_LEVEL:-6}
      
      # Housekeeping
      - GOFR_PLOT_BACKUP_CLEANUP_ON_START=${GOFR_PLOT_BACKUP_CLEANUP_ON_START:-true}
      - GOFR_PLOT_BACKUP_VERIFY_AFTER_BACKUP=${GOFR_PLOT_BACKUP_VERIFY_AFTER_BACKUP:-true}
      
      # Tiered retention (optional)
      - GOFR_PLOT_BACKUP_ENABLE_WEEKLY=${GOFR_PLOT_BACKUP_ENABLE_WEEKLY:-false}
      - GOFR_PLOT_BACKUP_ENABLE_MONTHLY=${GOFR_PLOT_BACKUP_ENABLE_MONTHLY:-false}
      - GOFR_PLOT_BACKUP_WEEKLY_RETENTION_WEEKS=${GOFR_PLOT_BACKUP_WEEKLY_RETENTION_WEEKS:-8}
      - GOFR_PLOT_BACKUP_MONTHLY_RETENTION_MONTHS=${GOFR_PLOT_BACKUP_MONTHLY_RETENTION_MONTHS:-12}
    volumes:
      - gofr_data:/data:ro              # Read-only access to app data
      - gofr_backups:/backups:rw        # Write access to backups
    networks:
      - gofr-net

# Shared Volume for Persistence
volumes:
  gofr_data:
    name: gofr-plot_data
    external: false # Set to true if you created it manually via CLI
  
  gofr_backups:
    name: gofr-plot_backups
    external: false

# Shared Network
networks:
  gofr-net:
    name: gofr-net
    external: true # Assumes network exists (created by other gofr services)
