#!/bin/bash
#
# gofr-plot.env - Single Source of Truth for gofr-plot Environment Configuration
#
# This file defines all environment variables and paths for the gofr-plot project.
# It supports two operational modes:
#   - TEST: Uses test/data/ for all storage (default for testing)
#   - PROD: Uses data/ for all storage (production deployments)
#
# Usage:
#   source gofr-plot.env
#   export GOFR_PLOT_ENV=PROD && source gofr-plot.env
#

# ============================================================================
# Environment Mode
# ============================================================================
export GOFR_PLOT_ENV="${GOFR_PLOT_ENV:-TEST}"

# Set base data path based on environment
if [ "${GOFR_PLOT_ENV}" = "PROD" ]; then
    GOFR_PLOT_ENV_PATH="data"
else
    GOFR_PLOT_ENV_PATH="test/data"
fi

# ============================================================================
# Project Root and Core Paths
# ============================================================================
export GOFR_PLOT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export GOFR_PLOT_DATA="${GOFR_PLOT_ROOT}/${GOFR_PLOT_ENV_PATH}"
export GOFR_PLOT_LOGS="${GOFR_PLOT_ROOT}/logs"

# ============================================================================
# Service-Specific Data Paths
# ============================================================================
export GOFR_PLOT_AUTH="${GOFR_PLOT_DATA}/auth"
export GOFR_PLOT_STORAGE="${GOFR_PLOT_DATA}/storage"
export GOFR_PLOT_METADATA="${GOFR_PLOT_DATA}/metadata"

# ============================================================================
# Token Store Path
# ============================================================================
# NOTE: Token store is environment-specific to prevent test/prod token collision
if [ "${GOFR_PLOT_ENV}" = "PROD" ]; then
    export GOFR_PLOT_TOKEN_STORE="${GOFR_PLOT_LOGS}/gofr-plot_tokens.json"
else
    export GOFR_PLOT_TOKEN_STORE="${GOFR_PLOT_LOGS}/gofr-plot_tokens_test.json"
fi

# ============================================================================
# Docker Network Configuration
# ============================================================================
export GOFR_PLOT_NETWORK="${GOFR_PLOT_NETWORK:-gofr-net}"

# ============================================================================
# Server Ports and Hosts (Centralized Configuration)
# ============================================================================
# Default host is 0.0.0.0 for container deployments (accessible from outside)
export GOFR_PLOT_HOST="${GOFR_PLOT_HOST:-0.0.0.0}"
export GOFR_PLOT_MCP_HOST="${GOFR_PLOT_MCP_HOST:-${GOFR_PLOT_HOST}}"
export GOFR_PLOT_MCPO_HOST="${GOFR_PLOT_MCPO_HOST:-${GOFR_PLOT_HOST}}"
export GOFR_PLOT_WEB_HOST="${GOFR_PLOT_WEB_HOST:-${GOFR_PLOT_HOST}}"

export GOFR_PLOT_MCP_PORT="${GOFR_PLOT_MCP_PORT:-8010}"
export GOFR_PLOT_MCPO_PORT="${GOFR_PLOT_MCPO_PORT:-8011}"
export GOFR_PLOT_WEB_PORT="${GOFR_PLOT_WEB_PORT:-8012}"

# ============================================================================
# Web Server URL Configuration
# ============================================================================
# Default to hostname-based URL for external accessibility
export GOFR_PLOT_HOSTNAME="${GOFR_PLOT_HOSTNAME:-$(hostname)}"
export GOFR_PLOT_WEB_URL="${GOFR_PLOT_WEB_URL:-http://${GOFR_PLOT_HOSTNAME}:${GOFR_PLOT_WEB_PORT}}"

# ============================================================================
# Auto-Create Required Directories
# ============================================================================
mkdir -p "${GOFR_PLOT_AUTH}" "${GOFR_PLOT_STORAGE}" "${GOFR_PLOT_METADATA}" "${GOFR_PLOT_LOGS}"

# ============================================================================
# Environment Validation and Display
# ============================================================================
if [ "${GOFR_PLOT_SHOW_ENV:-0}" = "1" ]; then
    echo "=== gofr-plot Environment Configuration ==="
    echo "GOFR_PLOT_ENV:          ${GOFR_PLOT_ENV}"
    echo "GOFR_PLOT_ROOT:         ${GOFR_PLOT_ROOT}"
    echo "GOFR_PLOT_DATA:         ${GOFR_PLOT_DATA}"
    echo "GOFR_PLOT_LOGS:         ${GOFR_PLOT_LOGS}"
    echo "GOFR_PLOT_AUTH:         ${GOFR_PLOT_AUTH}"
    echo "GOFR_PLOT_STORAGE:      ${GOFR_PLOT_STORAGE}"
    echo "GOFR_PLOT_METADATA:     ${GOFR_PLOT_METADATA}"
    echo "GOFR_PLOT_TOKEN_STORE:  ${GOFR_PLOT_TOKEN_STORE}"
    echo "GOFR_PLOT_NETWORK:      ${GOFR_PLOT_NETWORK}"
    echo "GOFR_PLOT_HOST:         ${GOFR_PLOT_HOST}"
    echo "GOFR_PLOT_MCP_HOST:     ${GOFR_PLOT_MCP_HOST}"
    echo "GOFR_PLOT_MCP_PORT:     ${GOFR_PLOT_MCP_PORT}"
    echo "GOFR_PLOT_MCPO_HOST:    ${GOFR_PLOT_MCPO_HOST}"
    echo "GOFR_PLOT_MCPO_PORT:    ${GOFR_PLOT_MCPO_PORT}"
    echo "GOFR_PLOT_WEB_HOST:     ${GOFR_PLOT_WEB_HOST}"
    echo "GOFR_PLOT_WEB_PORT:     ${GOFR_PLOT_WEB_PORT}"
    echo "GOFR_PLOT_WEB_URL:      ${GOFR_PLOT_WEB_URL}"
    echo "========================================"
fi
